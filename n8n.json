{
  "name": "Complaint/Damages",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "b881c94b-a224-4df4-af9c-c2d5cbe337cd",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        420,
        -60
      ],
      "id": "4a728091-40eb-4a90-bed3-bb263adc58fa",
      "name": "Webhook",
      "webhookId": "b881c94b-a224-4df4-af9c-c2d5cbe337cd",
      "notes": "Complaint/Damages"
    },
    {
      "parameters": {
        "url": "=https://api.carbone.io/render/{{ $json[\"data\"][\"renderId\"] }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "carbone-version"
            },
            {
              "name": "User-Agent",
              "value": "Apifox/1.0.0 (https://apifox.com)"
            },
            {
              "name": "Authorization",
              "value": "Bearer test_eyJhbGciOiJFUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiIxMTc0ODU5NTEzNDk2MjgzNDI3IiwiYXVkIjoiY2FyYm9uZSIsImV4cCI6MjQxMTc2OTM2OCwiZGF0YSI6eyJ0eXBlIjoidGVzdCJ9fQ.AKADhvkK8YkFcjZo2DOXrxq29pVwicDzHVGRPEgu64AH6BT9Llh5KXvESXZOlU1Uk8nlaW_aVsartAwwYi47xSsVAdguG832QGL-NahR2RxgDAeecg3MWawiks23xlKWIzJk5npnMC7cGbV47pSlmChImGw8JKhbigJJv3dBLPXYj60F"
            },
            {
              "name": "Accept",
              "value": "*/*"
            },
            {
              "name": "Host",
              "value": "api.carbone.io"
            },
            {
              "name": "Connection",
              "value": "keep-alive"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1300,
        -60
      ],
      "id": "6a4a082a-53a8-4540-b374-d776ed4431f2",
      "name": "ä¸‹è½½æ–‡ä»¶",
      "credentials": {
        "httpBearerAuth": {
          "id": "3w0MG48afEMdXUPz",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.carbone.io/render/{{ $json.templateId }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {}
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "convertTo",
              "value": "pdf"
            },
            {
              "name": "timezone",
              "value": "Europe/Paris"
            },
            {
              "name": "lang",
              "value": "en-us"
            },
            {
              "name": "data",
              "value": "={{ $json.body.formData }}"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1080,
        -60
      ],
      "id": "8c3ee4d3-5ded-437d-a002-07ec8f411573",
      "name": "ç”Ÿæˆæ–‡æ¡£",
      "credentials": {
        "httpBearerAuth": {
          "id": "3w0MG48afEMdXUPz",
          "name": "Bearer Auth account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a0f75a58-c453-4e0c-97d3-7e0d94276c4a",
              "name": "body",
              "value": "={{ $json.body }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        640,
        -60
      ],
      "id": "b56e753c-f814-4e89-8c01-1a6206302671",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "// ---------- Code èŠ‚ç‚¹ï¼šRun Once (All Items) ----------\n\nconst output = [];\n\nconst inputItems = $input.all();   // å…ˆæ‹¿ä¸€éï¼Œåé¢éœ€è¦ç´¢å¼•\n\nfor (let idx = 0; idx < inputItems.length; idx++) {\n    const item = inputItems[idx];\n    const {formData, formType} = item.json.body;\n    console.log(\"item.json\", item.json.body)\n    console.log(\"formData\", formData)\n    console.log(\"formType\", formType)\n    // â‘  æ ¹æ® formType é€‰æ‹© templateIds\n    let templateIds;\n    if (formType === 'complaint') {\n        templateIds = [\n            '41da9300137fbddc1a684fca397fb1e0362902ac528e21a66a73abfe3b3783e1',\n            'abd3a284f8d122ac4c233aeebdb4462f570792e21477dffad283ecabca1e2e49',\n        ];\n    } else if (formType === 'answer') {\n        templateIds = [\n            '253036470b30a42e5d587370279f9fb9780066366bc0a8bc7c248d6f87801e1d',\n        ];\n    } else if (formType === 'settlement') {\n        templateIds = [\n            '253036470b30a42e5d587370279f9fb9780066366bc0a8bc7c248d6f87801e1d',\n        ];\n    } else if (formType === 'demurrer') {\n        templateIds = [\n            '10cb4c4629c9c347a73ec78a36d64c946d7dadb295049d15c202fac7922bcbd2',\n            '8a84c243aa273569f0180cb12e6b71b3da276d320180b77b8d530baba3bf323c',\n            '81717929a11601a416e3bee6555416dd3466efbf42f1d9057d7589acaa178381',\n        ];\n    } else if (formType === 'motionToStrike') {\n        templateIds = [\n            'be2476066f00d3a76e4a0da8b331c1f1500a0dbe4bf0bb6eefa16f7d6e59af61',\n            'b12b89cc4b830f77281b014c7e002c7b1c09efb5ebb1124520ef21462b3e70dc',\n            'dff282f1306ed3fffd709c4de62acff21b6d7ee8c957c6465e55160b1d071b78',\n        ];\n    } else {\n        throw new Error(`æœªçŸ¥çš„ formType: ${formType}`);\n    }\n\n    // â‘¡ æ‹†åˆ†æˆå¤šæ¡è¾“å‡ºï¼›æ¯æ¡é™„å¸¦ pairedItem\n    for (const id of templateIds) {\n        output.push({\n            json: {\n                ...item.json,     // ä¿ç•™æ‰€æœ‰åŸå­—æ®µ\n                templateId: id,   // å•ä¸ª id\n            },\n            pairedItem: {       // å‘Šè¯‰ n8nï¼šå®ƒæ¥è‡ªç¬¬ idx æ¡è¾“å…¥\n                item: idx,\n            },\n        });\n    }\n}\n\nreturn output;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        860,
        -60
      ],
      "id": "b4637b35-9763-4180-a19b-2a1a9818c0be",
      "name": "Code"
    },
    {
      "parameters": {
        "fromEmail": "robin528919@gmail.com",
        "toEmail": "={{ $('Edit Fields').first().json.body.submissionEmail }}",
        "subject": "=æ³•å¾‹æ–‡æ¡£ - {{ $json.fileCount }} ä¸ªæ–‡ä»¶",
        "text": "æ‚¨å¥½ï¼Œ\n\næ‚¨æäº¤çš„æ³•å¾‹æ–‡æ¡£å·²ç”Ÿæˆå®Œæˆã€‚é™„ä»¶ä¸­åŒ…å«äº† {{ $json.fileCount }} ä¸ªPDFæ–‡ä»¶ã€‚\n\n{{ $json.message }}\n\nå¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·è”ç³»æˆ‘ä»¬ã€‚\n\næ­¤é‚®ä»¶ç”±ç³»ç»Ÿè‡ªåŠ¨å‘é€ã€‚",
        "options": {
          "attachments": "={{ $json.attachmentNames }}"
        }
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        1740,
        -60
      ],
      "id": "f96ac4a6-d047-41f0-a360-9c2304f8dbcc",
      "name": "å‘é€é‚®ä»¶",
      "webhookId": "2dab1a29-add1-4784-af55-512b40dd7f5f",
      "credentials": {
        "smtp": {
          "id": "g9UApp4PhDXfqXKF",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// åˆå¹¶å¤šä¸ªä¸‹è½½çš„æ–‡ä»¶åˆ°ä¸€ä¸ªé¡¹ç›®çš„äºŒè¿›åˆ¶æ•°æ®ä¸­\nconst items = $input.all();\nconst outputItem = {\n  json: {\n    fileCount: items.length,\n    message: `å¤„ç†äº† ${items.length} ä¸ªæ–‡ä»¶`\n  },\n  binary: {}\n};\n\nconsole.log('å¼€å§‹å¤„ç†', items.length, 'ä¸ªæ–‡ä»¶');\nconsole.log('ç¬¬ä¸€ä¸ªé¡¹ç›®çš„å®Œæ•´æ•°æ®:', JSON.stringify(items[0], null, 2));\n\n// å°†æ¯ä¸ªæ–‡ä»¶ä½œä¸ºå•ç‹¬çš„äºŒè¿›åˆ¶å±æ€§æ·»åŠ \nfor (let i = 0; i < items.length; i++) {\n  const item = items[i];\n  const binaryData = item.binary;\n  \n  console.log(`\\n=== å¤„ç†æ–‡ä»¶ ${i + 1} ===`);\n  console.log('Binary keys:', Object.keys(binaryData || {}));\n  \n  if (binaryData) {\n    // æŸ¥æ‰¾äºŒè¿›åˆ¶æ•°æ® - æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„é”®\n    const binaryKeys = Object.keys(binaryData);\n    let fileData = null;\n    let actualKey = null;\n    \n    // å¸¸è§çš„äºŒè¿›åˆ¶æ•°æ®é”®å\n    const possibleKeys = ['data', 'file', 'binary', 'attachment', 'document'];\n    \n    // é¦–å…ˆæ£€æŸ¥å¸¸è§é”®å\n    for (const key of possibleKeys) {\n      if (binaryData[key]) {\n        fileData = binaryData[key];\n        actualKey = key;\n        break;\n      }\n    }\n    \n    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„é”®\n    if (!fileData && binaryKeys.length > 0) {\n      actualKey = binaryKeys[0];\n      fileData = binaryData[actualKey];\n    }\n    \n    console.log(`ä½¿ç”¨é”®å: ${actualKey}`);\n    console.log('FileData ç±»å‹:', typeof fileData);\n    console.log('FileData ç»“æ„:', fileData ? Object.keys(fileData) : 'null');\n    \n    if (fileData) {\n      // æ ¹æ®è¡¨å•ç±»å‹å’Œæ¨¡æ¿ç”Ÿæˆæ–‡ä»¶å\n      const formType = item.json.body?.formType || 'document';\n      const templateId = item.json.templateId || 'unknown';\n      const shortTemplateId = templateId.substring(0, 8);\n      const propertyName = `file_${i}`;\n      \n      // åŠ¨æ€ç¡®å®šæ–‡ä»¶æ‰©å±•å\n      let fileExtension = 'bin'; // é»˜è®¤æ‰©å±•å\n      let mimeType = fileData.mimeType || 'application/octet-stream';\n      \n      // ä»åŸå§‹æ–‡ä»¶åä¸­æå–æ‰©å±•å\n      if (fileData.fileName) {\n        const originalExt = fileData.fileName.split('.').pop();\n        if (originalExt && originalExt.length <= 5) {\n          fileExtension = originalExt.toLowerCase();\n        }\n      }\n      \n      // æ ¹æ® MIME ç±»å‹ç¡®å®šæ‰©å±•åï¼ˆä¼˜å…ˆçº§æ›´é«˜ï¼‰\n      const mimeToExt = {\n        'application/pdf': 'pdf',\n        'application/msword': 'doc',\n        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',\n        'application/vnd.ms-excel': 'xls',\n        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',\n        'text/plain': 'txt',\n        'text/csv': 'csv',\n        'image/jpeg': 'jpg',\n        'image/png': 'png',\n        'image/gif': 'gif',\n        'application/zip': 'zip',\n        'application/json': 'json',\n        'text/xml': 'xml',\n        'application/xml': 'xml'\n      };\n      \n      if (mimeToExt[mimeType]) {\n        fileExtension = mimeToExt[mimeType];\n      }\n      \n      // ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å\n      const fileName = `${formType}_${shortTemplateId}_${i + 1}.${fileExtension}`;\n      \n      console.log(`å‡†å¤‡å¤åˆ¶æ–‡ä»¶æ•°æ®åˆ° ${propertyName}`);\n      console.log(`MIMEç±»å‹: ${mimeType}, æ‰©å±•å: ${fileExtension}`);\n      console.log(`åŸå§‹æ–‡ä»¶å: ${fileData.fileName || 'N/A'}`);\n      \n      // ç›´æ¥å¤åˆ¶å®Œæ•´çš„äºŒè¿›åˆ¶æ•°æ®å¯¹è±¡\n      outputItem.binary[propertyName] = {\n        ...fileData,  // å¤åˆ¶æ‰€æœ‰åŸå§‹å±æ€§\n        fileName: fileName,  // è¦†ç›–æ–‡ä»¶å\n        fileExtension: fileExtension,  // åŠ¨æ€æ‰©å±•å\n        mimeType: mimeType  // ç¡®ä¿MIMEç±»å‹\n      };\n      \n      console.log(`âœ… æˆåŠŸæ·»åŠ æ–‡ä»¶ ${propertyName}: ${fileName}`);\n      console.log(`æ–‡ä»¶å¤§å°: ${fileData.data ? fileData.data.length : 'unknown'} bytes`);\n    } else {\n      console.log(`âŒ æ–‡ä»¶ ${i + 1} æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„äºŒè¿›åˆ¶æ•°æ®`);\n    }\n  } else {\n    console.log(`âŒ æ–‡ä»¶ ${i + 1} æ²¡æœ‰ binary å±æ€§`);\n  }\n}\n\n// ç”Ÿæˆé™„ä»¶åç§°åˆ—è¡¨ï¼ˆç”¨äºSend EmailèŠ‚ç‚¹ï¼‰\nconst attachmentNames = Object.keys(outputItem.binary);\noutputItem.json.attachmentNames = attachmentNames.join(',');\n\n// ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®ä¸­è·å– submissionEmail\nif (items.length > 0 && items[0].json.body) {\n  outputItem.json.submissionEmail = items[0].json.body.submissionEmail;\n  console.log('\\nğŸ“§ è·å–åˆ°æäº¤é‚®ç®±:', outputItem.json.submissionEmail);\n}\n\nconsole.log(`\\nğŸ“ æœ€ç»ˆç”Ÿæˆäº† ${attachmentNames.length} ä¸ªé™„ä»¶:`, attachmentNames);\nconsole.log('è¾“å‡ºé¡¹çš„äºŒè¿›åˆ¶é”®:', Object.keys(outputItem.binary));\n\nreturn [outputItem];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        -60
      ],
      "id": "e1aaa117-6590-4983-a8c8-262ef1d091f7",
      "name": "å¤„ç†é™„ä»¶"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç”Ÿæˆæ–‡æ¡£": {
      "main": [
        [
          {
            "node": "ä¸‹è½½æ–‡ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ä¸‹è½½æ–‡ä»¶": {
      "main": [
        [
          {
            "node": "å¤„ç†é™„ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "ç”Ÿæˆæ–‡æ¡£",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç†é™„ä»¶": {
      "main": [
        [
          {
            "node": "å‘é€é‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "8b10b721-8a56-41a5-b47d-8d99c3bc4d56",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "12ebc04d3aaafd2f3e28ae3cf8a37a9b38e85b98ccaecf7cfa95b8942516673e"
  },
  "id": "ex5GgfQ0mALJ5lvk",
  "tags": []
}